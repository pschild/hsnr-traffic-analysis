<html>
  <head>
    <title>Counter</title>
  </head>
  <body>
    <button id="count-btn" disabled>Auto!</button>
    <button id="start-btn">Start</button>
    <button id="stop-btn" disabled>Stop</button>
    <div id="time">0</div>
    <div style="display: flex">
      <div id="log" style="width: 50%"></div>
      <div id="processed-log"></div>
    </div>

    <script>
      document.body.addEventListener('keydown', (event) => {
        event.stopPropagation();
        event.preventDefault();
        if (event.code == 'Space' || event.code == 'Enter') {
          count();
          log();
        }
      });

      document.getElementById('count-btn').addEventListener('click', () => {
        count();
        log();
      });

      document.getElementById('start-btn').addEventListener('click', (e) => {
        start();
        e.target.disabled = true;
        document.getElementById('count-btn').disabled = false;
        document.getElementById('stop-btn').disabled = false;
      });

      document.getElementById('stop-btn').addEventListener('click', (e) => {
        stop();
        e.target.disabled = true;
        document.getElementById('count-btn').disabled = true;
        document.getElementById('start-btn').disabled = false;
      });

      var STARTED = false;
      var INTERVAL;
      var SECONDS;
      var COUNTS;
      var logContainer = document.getElementById('log');
      var processedLogContainer = document.getElementById('processed-log');

      function start() {
        processedLogContainer.innerHTML = '';

        STARTED = true;
        SECONDS = 0;
        COUNTS = [];
        INTERVAL = setInterval(() => {
          SECONDS++;
          document.getElementById('time').innerText = SECONDS;
        }, 1000);
      }

      function stop() {
        STARTED = false;
        clearInterval(INTERVAL);
        document.getElementById('time').innerText = 0;

        if (COUNTS.length) {
          var lastItem = COUNTS[COUNTS.length - 1];
          var result = [];
          for (let i = 0; i <= lastItem.second; i += 5) {
            var filtered = COUNTS.filter(item => item.second >= i && item.second < i + 5);
            var sum = 0;
            filtered.forEach(item => {
              sum += item.count;
            });
            //console.log(i + '-' + (i+5) + ' => ' + sum);
            result.push({toSecond: i + 5, sum: sum});
            processedLogContainer.innerHTML += `bis ${i+5}s: ${sum}<br>`;
          }
          localStorage.setItem(`hsnr-traffic-analysis-${new Date().getTime()}`, JSON.stringify(result));
        }
      }

      function count() {
        if (!STARTED) {
          return;
        }
        var item = COUNTS.find(i => i.second == SECONDS);
        if (item) {
          item.count++;
        } else {
          COUNTS.push({second: SECONDS, count: 1});
        }
      }

      function log() {
        if (!STARTED) {
          return;
        }
        logContainer.innerHTML = '';
        COUNTS.forEach(item => {
          logContainer.innerHTML += `${item.second}s => ${item.count} Auto(s)<br>`;
        });
      }
    </script>
  </body>
</html>